
<!-- README.md is generated from README.Rmd. Please edit that file -->

# sf.extract

<!-- badges: start -->
<!-- badges: end -->

The goal of sf.extract is to â€¦

## Installation

``` r
# remotes::install_gitlab("r-pkgs/sf.extract")    # 
# remotes::install_github("rpkgs/sf.extract")     # only for private
install.packages("sf.extract-0.1.4.tar.gz", repos = NULL, type = "source", dependencies = TRUE)
```

## Example

``` r
library(raster)
library(terra)
library(sf.extract)
library(testthat)
```

``` r
file_shp = system.file("shp/Continents.shp", package = "sf.extract")
files = system.file("raster/PML2_yearly_static2017-01-01.tif", package = "sf.extract")

# shape files
st <- sf::read_sf(file_shp)
shp <- sf::as_Spatial(st)
wkbs = sf::st_as_binary(sf::st_geometry(st), EWKB = TRUE) %>% set_names(st[[1]])

b <- rast(files[1]) # read raster
b_in = raster::brick(files[1])[[1]] %>% readAll() %>% rast() # in memory

## 1. test for different poly obj
r_name = st_extract(files, st) # sf obj
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
#> [] running 1 ...
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
r_Id  = st_extract(files, st[, 2]) # sf obj
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
#> [] running 1 ...
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%

expect_equal(r_name[[1]]$CONTINENT, st$CONTINENT)
expect_equal(r_Id[[1]]$ID, st$ID)

r2 = st_extract(files, shp) # Spatial obj
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
#> [] running 1 ...
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
# get overlaped blocks first
blocks <- overlap(b, st)
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
r <- st_extract(b_in, blocks)
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
# b_in fast in 5.2 times
# microbenchmark::microbenchmark(
#     r <- st_extract(b, blocks),
#     r <- st_extract(b_in, blocks), times = 10
# )
r3 = st_extract(files, blocks, weight = FALSE)
#> [] running 1 ...
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
# default weight = TRUE, using area.weight, result differ significantly

## 2. test for different `st_` functions
st_extract(b_in, blocks, fun = sf_median)
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
#>            name       GPP
#> 1          Asia  548.2913
#> 2 North America  728.3939
#> 3        Europe 1170.7741
#> 4        Africa  488.6434
#> 5 South America 2048.9346
#> 6       Oceania 2611.0735
#> 7     Australia  286.7789
#> 8    Antarctica  135.3942
st_extract(b_in, blocks, fun = sf_sd)
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
#>            name       GPP
#> 1          Asia  925.7826
#> 2 North America  756.5855
#> 3        Europe  400.0304
#> 4        Africa  980.9998
#> 5 South America 1087.3081
#> 6       Oceania  894.5715
#> 7     Australia  596.1341
#> 8    Antarctica  192.7798
st_extract(b_in, blocks, fun = sf_sum) %>% print() # no colnames
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
#>            name         GPP
#> 1          Asia 37971750464
#> 2 North America 20618903346
#> 3        Europe 10795938589
#> 4        Africa 25996508647
#> 5 South America 36869217529
#> 6       Oceania   997430560
#> 7     Australia  4266795699
#> 8    Antarctica     1954401
st_extract(b_in, blocks, fun = sf_sum, weight = TRUE)
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
#>            name         GPP
#> 1          Asia 37971750464
#> 2 North America 20618903346
#> 3        Europe 10795938589
#> 4        Africa 25996508647
#> 5 South America 36869217529
#> 6       Oceania   997430560
#> 7     Australia  4266795699
#> 8    Antarctica     1954401
st_extract(b_in, blocks, fun = sf_var, weight = TRUE)
#>   |                                                                              |                                                                      |   0%  |                                                                              |=========                                                             |  12%  |                                                                              |==================                                                    |  25%  |                                                                              |==========================                                            |  38%  |                                                                              |===================================                                   |  50%  |                                                                              |============================================                          |  62%  |                                                                              |====================================================                  |  75%  |                                                                              |=============================================================         |  88%  |                                                                              |======================================================================| 100%
#>            name        GPP
#> 1          Asia  857073.42
#> 2 North America  572421.67
#> 3        Europe  160024.28
#> 4        Africa  962360.63
#> 5 South America 1182238.89
#> 6       Oceania  800258.16
#> 7     Australia  355375.91
#> 8    Antarctica   37164.05
```

## References

1.  <https://github.com/isciences/exactextract>
2.  <https://github.com/isciences/exactextractr>
